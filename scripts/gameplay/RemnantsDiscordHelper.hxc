import funkin.modding.module.Module;
import funkin.play.PlayState;
import Date;

class RemnantsDiscordHelper extends Module
{
  final ASSETS_URL:String = "https://remnants.tilnotdrip.org/discord/";
  final RAW_EXTENSION:String = ".png";

  function new()
  {
    super("remnants-discord-helper", 1);
  }

  var lastAlbum:String = null;
  var lastIcon:String = null;

  override public function onUpdate(event:UpdateScriptEvent):Void
  {
    super.onUpdate(event);

    if (PlayState.instance == null) return;
    if (!RemnantsContentUtil.remnantsContentEnabled()) return;

    if (lastAlbum != PlayState.instance.discordRPCAlbum)
    {
      updateAlbum();
      lastAlbum = PlayState.instance.discordRPCAlbum;
    }

    if (lastIcon != PlayState.instance.discordRPCIcon)
    {
      updateIcon();
      lastIcon = PlayState.instance.discordRPCIcon;
    }
  }

  function updateAlbum():Void
  {
    var album:String = 'album-' + (PlayState.instance?.currentChart?.album ?? 'remnants-general');
    PlayState.instance.discordRPCAlbum = ASSETS_URL + album + RAW_EXTENSION;

    PlayState.instance?.initDiscord();
  }

  function updateIcon():Void
  {
    var healthIcon:String = 'icon-' + (PlayState.instance?.currentStage?.getDad()?._data?.healthIcon?.id ?? 'bf-remnants');
    PlayState.instance.discordRPCIcon = ASSETS_URL + healthIcon + RAW_EXTENSION;

    PlayState.instance?.initDiscord();
  }
}
